<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>My Music Studio â€“ Video Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            margin: 0;
            background: #111;
            color: #fff;
        }

        header {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #d6004c, #7b1fa2);
        }

        .container {
            max-width: 1000px;
            margin: auto;
            padding: 40px 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: #1e1e1e;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 12px;
            font-size: 16px;
        }

        .tab.active {
            background: linear-gradient(135deg, #d6004c, #7b1fa2);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .upload-box {
            background: #1e1e1e;
            padding: 25px;
            border-radius: 12px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: none;
        }

        input[type="file"] {
            background: #fff;
            color: #000;
        }

        button {
            background: #d6004c;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .upload-area {
            border: 3px dashed #d6004c;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .upload-area.dragover {
            background: #2a2a2a;
        }

        .gallery {
            margin-top: 50px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .video-card {
            background: #1e1e1e;
            border-radius: 12px;
            overflow: hidden;
        }

        .video-card video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }

        .video-info {
            padding: 15px;
        }

        .video-actions {
            display: flex;
            gap: 10px;
            padding: 0 15px 15px;
        }

        .download-btn {
            background: #d6004c;
            color: #fff;
            text-decoration: none;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }

        .delete-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 8px;
            border-radius: 8px;
            flex: 1;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #777;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #777;
        }
    </style>
</head>

<body>

<header>
    <h1>ðŸŽ¶ My Music Studio</h1>
    <p>Gestione video locale con IndexedDB</p>
</header>

<div class="container">

    <div class="tabs">
        <button class="tab active" onclick="switchTab('import')">ðŸ“¤ Importa Video</button>
    </div>

    <div id="importSection" class="section active">
        <div class="upload-box">
            <input id="importTitle" placeholder="Titolo video">
            <input id="importArtist" placeholder="Artista">

            <div class="upload-area" id="uploadArea">
                <p style="font-size:40px">ðŸŽ¬</p>
                <p>Clicca o trascina un video</p>
            </div>

            <input type="file" id="importVideoFile" accept="video/*" hidden>
            <button id="importBtn" onclick="importVideo()" disabled>Aggiungi alla galleria</button>
        </div>
    </div>

    <div class="gallery" id="gallery" style="display:none">
        <h2>ðŸŽ¬ Galleria Video</h2>
        <div id="videoGrid" class="video-grid"></div>
    </div>

    <div class="empty-state" id="emptyState">
        <h3>Nessun video</h3>
        <p>Importa il tuo primo video</p>
    </div>

</div>

<footer>Â© 2025 â€“ My Music Studio</footer>

<script>
    const uploadArea = document.getElementById('uploadArea');
    const importVideoFile = document.getElementById('importVideoFile');
    const importBtn = document.getElementById('importBtn');
    const importTitle = document.getElementById('importTitle');
    const importArtist = document.getElementById('importArtist');
    const videoGrid = document.getElementById('videoGrid');
    const gallery = document.getElementById('gallery');
    const emptyState = document.getElementById('emptyState');

    let selectedFile = null;

    window.onload = loadGallery;

    uploadArea.onclick = () => importVideoFile.click();
    importVideoFile.onchange = e => handleFile(e.target.files[0]);

    uploadArea.ondragover = e => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    };

    uploadArea.ondragleave = () => uploadArea.classList.remove('dragover');

    uploadArea.ondrop = e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFile(e.dataTransfer.files[0]);
    };

    function handleFile(file) {
        if (!file || !file.type.startsWith('video/')) return alert("File non valido");
        selectedFile = file;
        uploadArea.innerHTML = `<p>âœ… ${file.name}</p>`;
        importBtn.disabled = false;
    }

    /* ---------- IndexedDB ---------- */
    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open("VideoDB", 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                db.createObjectStore("videos", { keyPath: "id" });
            };
            req.onsuccess = e => resolve(e.target.result);
            req.onerror = e => reject(e.target.error);
        });
    }

    async function saveVideo(blob, title, artist) {
        const db = await openDB();
        const tx = db.transaction("videos", "readwrite");
        const store = tx.objectStore("videos");
        const id = Date.now().toString();
        store.put({ id, blob, title, artist, date: Date.now() });
        return new Promise(res => tx.oncomplete = () => res(id));
    }

    async function getVideos() {
        const db = await openDB();
        const tx = db.transaction("videos", "readonly");
        const store = tx.objectStore("videos");
        return new Promise(res => store.getAll().onsuccess = e => res(e.target.result));
    }

    async function deleteVideo(id) {
        if (!confirm("Eliminare il video?")) return;
        const db = await openDB();
        const tx = db.transaction("videos", "readwrite");
        tx.objectStore("videos").delete(id);
        tx.oncomplete = loadGallery;
    }

    async function importVideo() {
        const title = importTitle.value || "Video importato";
        const artist = importArtist.value || "Sconosciuto";

        const reader = new FileReader();
        reader.onload = async () => {
            await saveVideo(new Blob([reader.result]), title, artist);
            importVideoFile.value = "";
            uploadArea.innerHTML = "<p>ðŸŽ¬ Clicca o trascina un video</p>";
            importBtn.disabled = true;
            loadGallery();
        };
        reader.readAsArrayBuffer(selectedFile);
    }

    async function loadGallery() {
        const videos = await getVideos();
        videoGrid.innerHTML = "";

        if (videos.length === 0) {
            gallery.style.display = "none";
            emptyState.style.display = "block";
            return;
        }

        videos.sort((a, b) => b.date - a.date).forEach(v => {
            const url = URL.createObjectURL(v.blob);
            const card = document.createElement("div");
            card.className = "video-card";
            card.innerHTML = `
                <video src="${url}" controls></video>
                <div class="video-info">
                    <strong>${v.title}</strong><br>
                    <small>${v.artist}</small>
                </div>
                <div class="video-actions">
                    <a class="download-btn" href="${url}" download="${v.title}.webm">Scarica</a>
                    <button class="delete-btn" onclick="deleteVideo('${v.id}')">Elimina</button>
                </div>
            `;
            videoGrid.appendChild(card);
        });

        gallery.style.display = "block";
        emptyState.style.display = "none";
    }
</script>

</body>
</html>
